!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Marionettist=e()}(this,function(){"use strict";var t,e,n,r=function(t,e){function n(){this.constructor=t}for(var r in e)o.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},o={}.hasOwnProperty;t=Marionette.extend(),t.Backbone=Backbone,t.Marionette=Marionette,t._=_,t.$=$,t.s=s,t.I18n=i18next,t.numeral=numeral,t.moment=moment,t.channels={request:function(e,n,r){return null==e&&(e="global"),null==n&&(n=""),null==r&&(r={}),t.Backbone.Radio.channel(e).request(n,r)},replyOnce:function(e,n,r){var o;return null==e&&(e="global"),null==n&&(n=""),o=t.Backbone.Radio.channel(e),t._.isFunction(r)?o.replyOnce(n,r):o.replyOnce(r)},reply:function(e,n,r){var o;return null==e&&(e="global"),null==n&&(n=""),o=t.Backbone.Radio.channel(e),t._.isFunction(r)?o.reply(n,r):o.reply(r)},publish:function(e,n,r){return null==e&&(e="global"),null==n&&(n=""),null==r&&(r={}),t.Backbone.Radio.channel(e).trigger(n,r)},subscribe:function(e,n,r){return null==e&&(e="global"),null==n&&(n=""),t.Backbone.Radio.channel(e).on(n,r)}},t.location={refreshRoute:function(t){return null==t&&(t=this.getCurrentRoute()),Backbone.history.loadUrl(t)},navigateTo:function(e,n){return null==n&&(n={}),t.Backbone.history.navigate(e,n)},getCurrentRoute:function(){var e;return e=t.Backbone.history.fragment,t._.isEmpty(e)?null:e},startHistory:function(e){return null==e&&(e={}),null!=t.Backbone.history?t.Backbone.history.start(e):void 0}},t.Env=function(){function e(){this.stage="development"}return e.current=function(){return this._current||(this._current=new e)},e.prototype.isDevelopment=function(){return"development"===this.stage},e.prototype.isProduction=function(){return"production"===this.stage},e.prototype.getLocale=function(){return t.I18n.language},e.prototype.setLocale=function(e,n){var r;return null==e&&(e="en"),null==n&&(n=null),r=this.getLocale(),t.I18n.changeLanguage(e,function(o){return t.channels.publish("marionettist","change:locale",{currentLocale:e,oldLocale:r}),t._.isFunction(n)?n(o):void 0})},e}(),t.Config=new t.Object,e=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return r(e,t),e.prototype.lookupPaths=["templates/"],e.prototype.engine=function(){var t;return t={},null!=root.HAML&&(t=HAML),null!=root.JST&&(t=JST),t},e}(t.Object),t.Config.options.templates=new e,_.extend(t.Renderer,{render:function(t,e){var n;if(_.isFunction(t))return t(e);if(t!==!1){if(n=this.getTemplate(t),!n)throw"Template "+t+" not found!";return n(e)}},getTemplate:function(e){var n,r,o,i,u,l,c,s,a;if(c=t.Config.getOption("templates").getOption("lookupPaths"),_.isFunction(c)&&(c=c()),!_.isArray(c))throw"lookupPaths most be an array";for(r=0,i=c.length;i>r;r++)for(l=c[r],a=[e,this.withTemplate(e)],o=0,u=a.length;u>o;o++)if(s=a[o],n=t.Config.getOption("templates").getOption("engine"),_.isFunction(n)&&(n=n()),n[l+s])return n[l+s]},withTemplate:function(t){var e;return null!=t?(e=t.split("/"),e.splice(-1,0,"templates"),e.join("/")):void 0}}),t.Utils=t._.extend(new t.Object,{log:function(e,n){var r;if(t.Env.current().isDevelopment()){switch(n=n||"black",r="White",n){case"success":n="Green",r="LimeGreen";break;case"info":n="DodgerBlue",r="Turquoise";break;case"error":n="Red",r="Black";break;case"start":n="OliveDrab",r="PaleGreen";break;case"warning":n="Tomato",r="Black";break;case"end":n="Orchid",r="MediumVioletRed";break;default:n=n}r="White","object"==typeof e?console.log(e):console.log("%c"+e,"color:"+n+";font-weight:bold; background-color: "+r+";")}},waitFor:function(e,n){var r,o;return null==n&&(n={}),o=[],o=_.chain([e]).flatten().value(),(r=t.$).when.apply(r,o).then(function(){return t._.isFunction(n.success)?n.success():void 0},function(e){return t._.isFunction(n.error)?n.error():void 0})}}),t.AppRoute=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return r(e,t),e.prototype.router=function(){return this.getOption("router")},e.prototype.path=function(){return this.getOption("path")},e.prototype.actionName=function(){return this.getOption("actionName")},e.prototype.controller=function(){return this.getOption("controller")},e}(t.Object),t.AppRouter=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return r(n,e),n.prototype.onRoute=function(t,e,n){return null!=this.controller&&_.isFunction(this.controller.onRoute)?this.controller.onRoute(this,t,e,n):void 0},n.prototype._setControllerFilters=function(e){var n,r;return null!=e&&(n={before:{},after:{}},r=e.filters,t._.isFunction(r)&&(r=r()),null==e.filters&&(e.filters={}),e.filters=t._.extend(n,r)),e},n.prototype._addAppRoute=function(e,n,r){var o,i;if(this.controller=this._setControllerFilters(e),o=e[r],i=function(e){return function(o){var i;return e.controller.route=new t.AppRoute({controller:e.controller,actionName:r,path:n}),i=e._executeFilter(e.controller.filters.before,e.controller),i!==!1?(e.controller[r].apply(e.controller,e._getParams()),e._executeFilter(e.controller.filters.after,e.controller)):void 0}}(this),!i)throw new Marionette.Error('Method "'+r+'" was not found on the controller');return this.route(n,r,_.bind(i,e))},n.prototype._executeFilter=function(e,n){var r,o,i,u,l,c,s;for(c=!0,l=_.keys(e),o=0,i=l.length;i>o;o++)switch(u=l[o],r=e[u],s="Action halted by filter '"+u+"'",!1){case!t._.isFunction(r):if(c=r(n),c===!1){"undefined"!=typeof console&&null!==console&&console.warn(s);break}break;case!t._.isObject(r):if(c=this._proccessFilterObject(u,r,n),c===!1){"undefined"!=typeof console&&null!==console&&console.warn(s);break}}return c},n.prototype._getParams=function(){var t,e;return e=this._routeToRegExp(this.controller.route.getOption("path")),t=this._extractParameters(e,Backbone.history.getFragment())},n.prototype._proccessFilterObject=function(e,n,r){var o,i,u,l;if(u={method:null,only:[],except:[]},l=t._.extend(u,n),i=r[e],o=r.route.actionName(),!_.isArray(l.only))throw"filter option only, most be an array";if(!_.isArray(l.except))throw"filter option except, most be an array";if(l.only.length>0||l.except.length>0){if(t._.contains(l.only,o)&&!t._.contains(l.except,o)&&t._.isFunction(i))return i.apply(this.controller,this._getParams())}else if(t._.isFunction(i))return i.apply(this.controller,this._getParams())},n}(Marionette.AppRouter),n=Marionette.Region.prototype.show,t.Region=function(e){function o(){return o.__super__.constructor.apply(this,arguments)}return r(o,e),o.prototype.show=function(e,r){var o,i;return r=r||{},o=this.currentView,i=function(i){return function(){var u;return u=[e,t._.extend(r,{preventDestroy:!0})],n.apply(i,u),r.preventDestroy?void 0:o.destroy()}}(this),null!=o&&t._.isFunction(o.onHide)?o.onHide(i,this):i()},o}(Marionette.Region),t.Views=new t.Object,t.Views.templateHelpers={t:t.I18n.t,formatCurrency:function(e,n){return null==n&&(n="$0,0.00"),t.numeral(e).format(n)},formatNumber:function(e,n){return null==n&&(n="0,0.00"),t.numeral(e).format(n)},formatPercentage:function(e,n){return null==n&&(n="0.00%"),t.numeral(e).format(n)},formatDate:function(e,n){return null==n&&(n="DD-MM-YYYY"),t.moment(e).format(n)}},_.extend(t.View.prototype,{templateHelpers:function(){var e;return e=t.Views.templateHelpers,null!=this.viewContext?(e.viewContext=this.viewContext,t._.isFunction(this.viewContext)&&(e.viewContext=this.viewContext())):e.viewContext={},e}}),t.Views.Collection=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return r(e,t),e}(Marionette.CollectionView),t.Views.Composite=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return r(e,t),e}(Marionette.CompositeView),t.Views.Item=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return r(e,t),e}(Marionette.ItemView),t.Views.Layout=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return r(e,t),e}(Marionette.LayoutView),t.Entities=new t.Object,t.Entities.Models=new t.Object,t.Entities.Collections=new t.Object,t.Entities.Models.Base=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return r(e,t),e}(Backbone.Model),Backbone.AssociatedModel&&(t.Entities.Models.Associated=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return r(e,t),e}(Backbone.AssociatedModel)),t.Entities.Collections.Base=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return r(e,t),e}(Backbone.Collection),t.Controllers.Base=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return r(e,t),e}(t.Object),t.Application=t.Application.extend({Backbone:t.Backbone,Marionette:t.Marionette,_:t._,$:t.$,s:t.s,I18n:t.I18n,numeral:t.numeral,moment:t.moment,Controllers:new t.Object,Entities:new t.Object,Views:new t.Object,navigateTo:function(e,n){return null==n&&(n={}),t.location.navigateTo(e,n)},getCurrentRoute:function(){return t.location.getCurrentRoute()},startHistory:function(e){return null==e&&(e={}),t.location.startHistory(e)},register:function(t,e){return null==this._registry&&(this._registry={}),this._registry[e]=t},unregister:function(t,e){return delete this._registry[e]},resetRegistry:function(){var t,e,n,r,o;r=this.getRegistrySize(),o=this._registry;for(e in o)t=o[e],t.region.close();return n="There were "+r+" controllers in the registry, there are now "+this.getRegistrySize(),this.getRegistrySize()>0?console.warn(n,this._registry):console.log(n)},getRegistrySize:function(){return t._.size(this._registry)}});var i=t;return i});